# Post-MVP 里程碑执行进度：M1～M8 + M12（暂不做 M10～M11）

- 计划来源：`docs/plans/2026-01-31-post-mvp-m1-m8-m12.md`
- PRD 入口：`docs/prds/README.md`
- 开始日期（建议）：2026-02-02
- 最后更新：2026-01-31

## 状态约定

- `TODO`：未开始
- `DOING`：进行中
- `DONE`：已完成
- `BLOCKED`：阻塞（需要外部输入/环境/决策）

## 总体进度

- 任务完成：42 / 61
- 当前 Sprint：未开始

## 任务进度（建议执行顺序）

### Batch 1：M3（/runs 失败可定位）

1. M3R-1：Runs 列表失败摘要（primary error.code + 简短原因 + retryable）
   - 状态：DONE
2. M3R-2：错误码→建议动作映射表（Top codes + 兜底）
   - 状态：DONE
3. M3R-3：Run 详情 errors/warnings 结构化展示（分组/折叠/主错误突出）
   - 状态：DONE
4. M3R-4：redacted_context 前端白名单展示（脱敏与截断）
   - 状态：DONE

### Batch 2：M1（vCenter 6.5 兼容性）

5. M1-1：Source 配置新增 `preferred_vcenter_version`（表单 + API 校验 + 阻断口径）
   - 状态：DONE
6. M1-2：vCenter detect 输出版本/能力/driver（best-effort + 建议口径）
   - 状态：DONE
7. M1-3：vCenter 6.5 collect_hosts 兼容性修正（关键字段/关系 fail-fast）
   - 状态：DONE
8. M1-4：vCenter 6.5 collect_vms 兼容性修正（关键字段/关系 fail-fast）
   - 状态：DONE
9. M1-5：`relations=0` 硬失败（`INVENTORY_RELATIONS_EMPTY`）+ 文档注册
   - 状态：DONE
10. M1-6：回归清单与最小真实环境验证记录（6.5 + 7.0+ 不回归）
    - 状态：BLOCKED
    - 阻塞：需要可用 vCenter 6.5 真实环境执行（清单见 `docs/runbooks/vcenter-6.5-compat-checklist.md`）

### Batch 3：M3（/assets 列表/详情增强）

11. M3A-1：/assets URL query 同步（q/asset_type/exclude_asset_type/source_id/page/pageSize）
    - 状态：DONE
12. M3A-2：/assets 筛选补齐（vm_power_state、ip_missing）+ API 支撑
    - 状态：DONE
13. M3A-3：UserPreference 表 + `GET/PUT /api/v1/me/preferences`（assets.table.columns.v1）
    - 状态：DONE
14. M3A-4：列设置 UI（显示/隐藏、恢复默认、DB 持久化）
    - 状态：DONE
15. M3A-5：详情字段字典（中文字段名 + 分组 + formatHint）+ 值渲染规则落地
    - 状态：DONE
16. M3A-6：关系链视图（VM→Host→Cluster）+ 调试关系表保留
    - 状态：DONE

### Batch 4：M2（Host Datastore 明细）

17. M2-1：Schema 扩展（normalized-v1/canonical-v1：`storage.datastores[]`）
    - 状态：DONE
18. M2-2：vCenter 采集 Host Datastores（name/capacity_bytes）+ 与总容量同口径
    - 状态：DONE
19. M2-3：Core 入库 + canonical 聚合 + provenance
    - 状态：DONE
20. M2-4：Host 详情 Datastores 区块（表格 + 总容量 + 空状态）
    - 状态：DONE
21. M2-5：回归：明细求和 == 总容量（至少 1 套真实环境）
    - 状态：BLOCKED
    - 阻塞：需要可用 vCenter 真实环境执行（目标：验证 sum(storage.datastores[].capacity_bytes) == attributes.datastore_total_bytes）

### Batch 5：M6（PVE 采集）

22. M6-1：PVE 插件脚手架 + config/credential schema（api_token/user_password）
    - 状态：DONE
23. M6-2：healthcheck/detect（capability probe + driver）
    - 状态：DONE
24. M6-3：collect（standalone：Host/VM + VM→Host）
    - 状态：DONE
25. M6-4：collect（cluster：Cluster/Host/VM + Host→Cluster + VM→Host best-effort）
    - 状态：DONE
26. M6-5：错误码注册（PVE\_\* + INVENTORY_RELATIONS_EMPTY）+ M3 建议动作补齐
    - 状态：DONE
27. M6-6：回归：5.x/8.x 差异覆盖（真实环境或 raw 回放）
    - 状态：BLOCKED
    - 阻塞：需要可用 PVE 5.x/8.x 真实环境或录制 raw fixture（目前仅有 mock 回放用例）

### Batch 6：M4（Hyper-V 采集）

28. M4-1：Hyper-V 插件脚手架 + WinRM 连接/凭证 schema
    - 状态：DONE
29. M4-2：healthcheck/detect（standalone/cluster 形态识别）
    - 状态：DONE
30. M4-3：collect（standalone：Host/VM + VM→Host）
    - 状态：DONE
31. M4-4：collect（cluster：Cluster/Host/VM + Host→Cluster + VM→Host best-effort；S2D 形态 best-effort）
    - 状态：DONE
32. M4-5：错误码注册（HYPERV\_\* + INVENTORY_RELATIONS_EMPTY）+ M3 建议动作补齐
    - 状态：DONE
33. M4-6：回归：单机 + Failover Cluster（最小集）
    - 状态：BLOCKED
    - 阻塞：需要可用 Hyper-V 单机 + Failover Cluster 环境执行（清单见 `docs/runbooks/hyperv-collector-checklist.md`）

### Batch 7：M5（下线语义 + 重复中心）

34. M5D-1：DB 扩展 asset_source_link presence（present/missing）+ last_seen_run_id
    - 状态：DONE
35. M5D-2：在成功且 inventory_complete 的 collect 后推进 missing/offline（per-source + overall）
    - 状态：DONE
36. M5D-3：DuplicateCandidate 表 + 规则实现（dup-rules-v1）+ 异步 job + 幂等/降噪
    - 状态：DONE
37. M5D-4：重复中心 API（list/detail/ignore）+ Ignore 审计事件
    - 状态：DONE
38. M5D-5：重复中心 UI（列表/详情/对比/Ignore/进入 Merge）
    - 状态：DONE

### Batch 8：M5（人工合并 Merge + 审计）

39. M5M-1：merge_audit 表（primary_wins）+ 审计事件 `asset.merged`
    - 状态：DONE
40. M5M-2：合并 API（同 asset_type；环检测；VM 合并门槛：primary in_service + secondary offline）
    - 状态：DONE
41. M5M-3：合并事务：link 迁移 + relations 重定向去重 + merged 资产默认隐藏/跳转
    - 状态：DONE
42. M5M-4：合并 UI（冲突字段对比 + 策略提示 + 成功后跳转）
    - 状态：DONE
43. M5M-5：相关 DuplicateCandidate 自动置 `merged`（终态）
    - 状态：DONE

### Batch 9：M8（台账字段闭环）

44. M8L-1：ledger-fields-v1 固定字段落库（vm/host 范围 + 索引）
    - 状态：DONE
45. M8L-2：单资产保存 API（admin-only）+ 校验/错误码 + 审计（saved）
    - 状态：DONE
46. M8L-3：批量设置 API（admin-only，N<=100，一次 1 字段）+ 审计（bulk_set）
    - 状态：DONE
47. M8L-4：/assets 列表：台账字段可选列 + q 命中 + 过滤（company/department/systemCategory/systemLevel）
    - 状态：TODO
48. M8L-5：/assets/[uuid]：台账字段编辑模式（admin-only）+ user 只读展示
    - 状态：TODO

### Batch 10：M8（全量导出 CSV）

49. M8E-1：asset_ledger_export 表 + 导出任务状态机（Queued/Running/Succeeded/Failed/Expired）
    - 状态：TODO
50. M8E-2：导出任务 API（create/status/download；admin-only；下载即失效 410）
    - 状态：TODO
51. M8E-3：导出生成器（cursor 分批读取 + RFC4180 转义 + UTF-8 无 BOM）
    - 状态：TODO
52. M8E-4：导出 UI（任务列表/状态/下载）+ 审计（exported）
    - 状态：TODO

### Batch 11：M12（资产历史追溯）

53. M12-1：定义 AssetHistoryEvent 契约 + eventType 枚举 + cursor 分页
    - 状态：TODO
54. M12-2：collect.changed 事件生成（关键字段/关系变化摘要；无变化不生成）
    - 状态：TODO
55. M12-3：ledger_fields.changed（投影 audit_event）+ asset.merged（投影 merge_audit）
    - 状态：TODO
56. M12-4：asset.status_changed（依赖 M5 presence/offline）事件生成
    - 状态：TODO
57. M12-5：资产详情“历史/时间线”UI（筛选 + 分页 + refs 跳转）
    - 状态：TODO

### Batch 12：M7（user 只读）

58. M7-1：服务端鉴权分层（requireUser/requireAdmin）覆盖主要 API
    - 状态：TODO
59. M7-2：新增 sources/summary（供 user 侧筛选；不含 endpoint/config/credential）
    - 状态：TODO
60. M7-3：UI 无入口（导航/按钮/页面路由）+ 直接访问 admin 页重定向或无权限页
    - 状态：TODO
61. M7-4：越权回归用例（403=AUTH_FORBIDDEN；raw/导出/治理/触发 Run 等）
    - 状态：TODO
