# Post-MVP 里程碑执行计划：M1～M8 + M12（暂不做 M10～M11）

日期：2026-01-31  
计划起始（建议）：2026-02-02（周一）

## 1. 范围与约束

### In Scope（本计划覆盖）

- M1：vCenter 6.5 兼容性增强（detect/collect_hosts/collect_vms）
- M2：采集项优化（Host Datastore 明细：名称 + 容量）
- M3：UI 优化（/runs 失败可定位 + /assets 列表/详情增强）
- M4：Hyper-V 采集（单机 + Failover Cluster（含 S2D 形态识别））
- M5：重复资产治理（重复中心 + 下线语义）+ 人工合并（Merge）与审计
- M6：PVE 采集（兼容 5.0～8.0）
- M7：普通用户（user）只读访问
- M8：台账字段闭环（ledger-fields-v1）+ 全量导出 CSV
- M12：资产历史追溯（按资产的事件时间线）

### Out of Scope（明确不做）

- M10：Windows/Linux 物理机采集（本期不实现）
- M11：阿里云采集（本期不实现）

## 2. 执行假设（用于排期；如不符合可再调整）

- 人力假设（推荐）：**2 人并行**
  - Track A（平台/DB/API/UI）：1 名全栈
  - Track B（Collector 插件）：1 名采集插件工程师
- 节奏：2 周一个 Sprint（周一开始，周五结束；中间周末不计入交付）
- 验收环境可用：
  - vCenter Server 6.5（M1 必需）
  - 至少 1 套 PVE（覆盖 5.x 与 8.x 的差异可用 raw/回放补齐）
  - 至少 1 套 Hyper-V（单机）+ 1 套 Failover Cluster（可用最小集验证）
- 质量门槛（每个 Sprint 收尾必须通过）：
  - `bun run lint`
  - `bun run format:check`
  - `bun run type-check`
  - 关键 API 的 `route.test.ts`（已有测试模式延续）
  - 插件侧 `plugins/*/__tests__` + 最小集成回放用例（可用 raw fixture）

## 3. 依赖关系（决定“先做什么”）

硬依赖（必须先后）：

- M3（/assets 列配置 DB 持久化）→ M8（台账字段列展示）
- M5（presence/offline + merge）→ M12（治理事件、状态变化事件）
- M8（台账字段审计事件）→ M12（ledger_fields.changed 事件）
- M12（历史入口）→ M7（user 只读可见历史入口）

软依赖（建议，但可并行）：

- M3（/runs 失败可定位）对所有采集/治理类里程碑都有“排障提效”，建议优先。
- M2（Datastore UI 区块）依赖 M3（详情信息组织）但可先落后端/Schema。

## 4. 总体排期（Sprint 级进度表）

> 说明：以下为“2 人并行”的推荐排期；若仅 1 人执行，可按依赖将 Sprint 串行，整体周期通常增加 60%～100%。

| Sprint | 日期（周一～周五）       | Track A（平台/DB/API/UI）交付                                                   | Track B（Collector 插件）交付                                                                                  |
| ------ | ------------------------ | ------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------- |
| S1     | 2026-02-02 ～ 2026-02-13 | M3（/runs）：错误摘要 + 建议动作映射表 + 详情结构化展示（含脱敏白名单）         | M1（vCenter）：补齐 `preferred_vcenter_version` 配置口径（Source 表单/API 校验）+ detect 输出版本/能力探测骨架 |
| S2     | 2026-02-16 ～ 2026-02-27 | M3（/assets）：URL 同步 + 列配置（UserPreference 表/API）                       | M1（vCenter）：6.5 兼容性修正（关键字段/关系 fail-fast；`relations=0` 失败）+ 回归清单                         |
| S3     | 2026-03-02 ～ 2026-03-13 | M3（/assets/[uuid]）：字段字典 + 值渲染 + 关系链视图（VM→Host→Cluster）         | M2（vCenter）：Host Datastore 明细采集（name/capacity）+ schema/canonical 落点                                 |
| S4     | 2026-03-16 ～ 2026-03-27 | M2：资产详情 Datastores 区块（表格 + 总容量一致性提示）                         | M6（PVE）：healthcheck/detect/collect（standalone）通路 + 错误码/契约对齐                                      |
| S5     | 2026-03-30 ～ 2026-04-10 | M5：presence/offline 语义落库 + 资产状态汇总（in_service/offline）              | M6（PVE）：cluster 模式 + IP best-effort（guest agent）+ 回归用例（5.x/8.x）                                   |
| S6     | 2026-04-13 ～ 2026-04-24 | M5：重复中心（DuplicateCandidate）后端 job + API + Ignore + 审计事件            | M4（Hyper-V）：healthcheck/detect/collect（standalone）通路 + 错误码/契约对齐                                  |
| S7     | 2026-04-27 ～ 2026-05-08 | M5：人工合并（Merge）API + UI + merge_audit（primary_wins）                     | M4（Hyper-V）：cluster（含 S2D 形态识别 best-effort）+ 回归用例                                                |
| S8     | 2026-05-11 ～ 2026-05-22 | M8：ledger-fields-v1（DB schema + API + 单资产编辑 + 批量设置 + 搜索/筛选命中） | 缓冲/回归：补齐新 SourceType（pve/hyperv）在 Source 表单/凭证 schema 的边界与测试                              |
| S9     | 2026-05-25 ～ 2026-06-05 | M8：全量导出 CSV（异步任务 + 下载即失效 + 审计）                                | 缓冲/回归：采集侧错误码补齐到 UI 建议动作映射表                                                                |
| S10    | 2026-06-08 ～ 2026-06-19 | M12：资产历史（事件模型 + API + UI 时间线 + cursor 分页 + 事件筛选）            | 缓冲/回归：提供用于 history 回填/回放的 raw fixture（可选）                                                    |
| S11    | 2026-06-22 ～ 2026-07-03 | M7：user 只读（路由/接口白名单 + sources/summary + 越权用例）                   | 缓冲：联调 + 修复                                                                                              |
| S12    | 2026-07-06 ～ 2026-07-10 | 收口：全链路回归 + 文档对齐 + Playwright Smoke（可选）                          | 收口：采集回归 + 文档对齐                                                                                      |

## 5. 里程碑拆解（任务清单级）

> 说明：以下拆解用于落到进度表（`.progress.md`）里按任务跟踪；每个里程碑建议在实现前先补齐“验收用例/错误码/文档同步项”。

### M3（/runs 失败可定位）

- 前端：实现 `primary_error` 规则（errors[0] 优先；兜底 errorSummary）
- 前端：`ErrorCode -> {标题/原因/建议动作(steps/links)}` 映射表（Top codes + 兜底）
- 前端：Runs 列表展示失败摘要（code + 简短原因 + retryable）；支持行内展开建议动作摘要
- 前端：Run 详情结构化展示 errors/warnings（按 code 分组折叠、warnings 默认折叠）
- 安全：`redacted_context` 展示白名单（避免 endpoint/账号/密钥泄露）
- 文档：必要时同步 `docs/design/asset-ledger-ui-spec.md`（错误展示形态/脱敏口径）

### M1（vCenter 6.5 兼容性）

- Source 配置：为 vCenter Source 增加 `preferred_vcenter_version`（必填，枚举：`6.5-6.7` / `7.0-8.x`）
- 插件：detect 输出 `target_version/capabilities/driver/recommended_preferred_version`（best-effort）
- 插件：6.5 的字段/结构差异兼容（关键字段缺失 fail-fast；非关键 best-effort warning）
- 插件：collect_hosts/collect_vms 在 `relations=0` 时硬失败（错误码 `INVENTORY_RELATIONS_EMPTY`）
- UI/阻断：Source 缺失版本配置时阻止运行 collect\_\* 并给出修复提示
- 回归：形成“vCenter 6.5 兼容性验证清单”（手工步骤 + 期望输出摘要）

### M3（/assets 列表/详情增强）

- 列表：URL query 同步（q/asset_type/exclude_asset_type/source_id/page/pageSize）
- 列表：补齐筛选项（vm_power_state、ip_missing；后端若缺参数需扩展 API）
- 列配置：UserPreference 表 + `GET/PUT /api/v1/me/preferences`（key=assets.table.columns.v1）
- 详情：字段字典（field registry）+ 中文字段名 + groupA/groupB + formatHint
- 详情：值渲染规范落地（bytes/datetime/enum/array/object 兜底）
- 详情：关系链视图（VM→Host→Cluster）+ 调试视角的关系表保留

### M2（Host Datastore 明细）

- Schema：扩展 normalized-v1 / canonical-v1，新增 `storage.datastores[]`（name/capacity_bytes）
- 插件：采集 datastore 明细，并保证与现有 `datastore_total_bytes` 同过滤口径
- Core：入库与 canonical 聚合保留 sources/provenance
- UI：Host 详情新增 Datastores 区块（表格 + 总容量；空状态引导到 Run warnings）
- 回归：至少 1 套真实 vCenter 环境验证“明细求和 = 总容量”

### M6（PVE 采集）

- 插件：config/credential（api_token / user_password）schema；healthcheck/detect/collect
- 插件：兼容 5.0～8.0（capability probe；版本号仅 fallback）
- 插件：standalone/cluster 形态；VM→Host、Host→Cluster 关系 best-effort + `relations=0` 硬失败策略
- 插件：错误码注册（PVE\_\* + INVENTORY_RELATIONS_EMPTY）
- 平台：SourceType=pve 的 Source 表单/凭证 UI/校验接入
- 回归：最小权限集 + 典型错误码（auth/permission/network/rate_limit）用例

### M4（Hyper-V 采集）

- 插件：WinRM/PowerShell Remoting 方案落地；healthcheck/detect/collect
- 插件：standalone/cluster（Failover Cluster）形态；S2D 仅做形态识别 best-effort
- 插件：`inventory_complete` 强约束；任一节点不可达视为失败（避免误推进 missing）
- 插件：错误码注册（HYPERV\_\* + INVENTORY_RELATIONS_EMPTY）
- 平台：SourceType=hyperv 的 Source 表单/凭证 UI/校验接入（含 tls_verify/scope/max_parallel_nodes）
- 回归：单机 + cluster 的最小集成验证清单

### M5（重复中心 + 下线语义 + 合并）

- DB：扩展 `asset_source_link`（presence_status、last_seen_run_id 等）并在成功且 `inventory_complete=true` 的 collect 后推进 missing/offline
- DB：新增 `duplicate_candidate`、`merge_audit`（对齐 `docs/design/asset-ledger-data-model.md`）
- 后端：dup-rules-v1 候选生成 job（异步；幂等；ignored 终态降噪）
- UI：重复中心列表/详情 + Ignore（永久）+ 审计事件
- 后端/UI：合并 API + UI（primary_wins；VM 合并门槛：primary in_service + secondary offline）
- 兼容：合并后 merged 资产默认隐藏；直接访问 merged 资产跳转主资产

### M8（台账字段闭环 + 导出 CSV）

- DB：ledger-fields-v1 固定字段落库（建议定长列/索引），仅覆盖 vm/host
- API：单资产保存 `PUT /api/v1/assets/:uuid/ledger-fields`（admin-only）+ 批量 `POST /api/v1/assets/ledger-fields/bulk-set`（N<=100）
- 列表：台账字段可选列 + `q` 命中 + 按 company/department/systemCategory/systemLevel 过滤
- 审计：`asset.ledger_fields_saved` / `asset.ledger_fields_bulk_set` / `asset.ledger_exported`
- 导出：`POST/GET /api/v1/exports/asset-ledger*` 异步任务 + 下载即失效（410）
- CSV：列名/顺序稳定（追加扩展策略）；RFC4180 风格转义；UTF-8 无 BOM

### M12（资产历史追溯）

- 事件模型：`collect.changed` / `ledger_fields.changed` / `asset.merged` / `asset.status_changed`
- API：`GET /api/v1/assets/:uuid/history?cursor&limit&type`（cursor 分页 + 类型筛选）
- 采集变化事件：仅在“关键字段/关系发生变化”时生成（避免退化为 Run 列表）
- 合并链：主资产历史需包含被合并资产事件，并标注 `sourceAssetUuid`
- UI：资产详情“历史/时间线”入口 + 时间线卡片（可跳转 run/audit/merge 引用）

### M7（user 只读）

- 鉴权：实现 `requireUser/requireAdmin`（服务端强制，前端仅做无入口）
- API：新增 `GET /api/v1/sources/summary`（供筛选；不返回 endpoint/config/credential）
- UI：user 导航仅保留 Assets/Runs；屏蔽 Sources/调度/治理/导出/raw/触发 Run
- 越权回归：对所有 admin-only API 做 403（`AUTH_FORBIDDEN`）用例覆盖
